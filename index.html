<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Маршрут на карте с Gist</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
<style>
html, body {margin:0; height:100%; font-family:Arial;}
#map {width:100%; height:100%;}

/* общая панель маршрута и команд */
#sidePanel {
    position: fixed;
    right: 20px;
    top: 20px;
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    padding: 12px;
    max-width: 320px;
    max-height: 500px;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    font-size: 14px;
    z-index: 1000;
    transition: transform 0.3s, opacity 0.3s;
}
#sidePanel.collapsed {
    transform: translateX(110%);
    opacity: 0;
}

#sidePanel h4 {margin:8px 0;}
#routeList, #commandList {margin:0; padding-left:0;}
#routeList li {
    display:flex;
    justify-content: space-between;
    align-items:center;
    margin-bottom:4px;
}
#routeList button.deleteBtn {
    background:#dc3545;
    border:none;
    color:white;
    cursor:pointer;
    border-radius:4px;
    padding:2px 6px;
}
#commandList button {
    display:block;
    width:100%;
    padding:6px 10px;
    margin-bottom:6px;
    cursor:pointer;
    text-align:left;
    border:1px solid #ccc;
    border-radius:6px;
    background:#f0f0f0;
}

/* кнопки сохранения */
#saveRouteBtn {
    flex:1;
    padding:6px 10px;
    border:none;
    border-radius:6px;
    background:#28a745;
    color:white;
    cursor:pointer;
}
#saveLocalBtn {
    flex:1;
    padding:6px 10px;
    border:none;
    border-radius:6px;
    background:#17a2b8;
    color:white;
    cursor:pointer;
}

/* отдельная кнопка сворачивания/разворачивания */
#panelToggleBtn {
    position: fixed;
    right: 20px;
    top: 20px;
    z-index: 1100;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
}

/* токен */
#tokenPrompt {
    display:none;
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    justify-content:center; align-items:center;
    background:rgba(0,0,0,0.4);
}
#tokenPrompt > div {background:white; padding:24px; border-radius:16px; text-align:center; min-width:300px;}
#tokenPrompt input {width:100%; padding:8px; margin-top:12px;}
#tokenPrompt button {width:100%; padding:10px; margin-top:12px;}
#tokenError {color:red; margin-top:8px;}
</style>
</head>
<body>
<div id="map"></div>

<div id="tokenPrompt">
    <div>
        <div>Введите GitHub токен для доступа к Gist:</div>
        <input type="text" id="gistTokenInput" placeholder="ghp_...">
        <button onclick="saveToken()">Сохранить</button>
        <div id="tokenError"></div>
    </div>
</div>

<!-- объединённая панель маршрута и команд -->
<div id="sidePanel">
    <h4>Маршрут</h4>
    <ul id="routeList"></ul>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="saveRouteBtn" onclick="saveRouteToGist()">Сохранить маршрут</button>
        <button id="saveLocalBtn" onclick="saveRouteLocally()">Сохранить локально</button>
    </div>
    <h4>Команды для выбранной точки</h4>
    <div id="commandList">(выберите точку на карте)</div>
</div>

<button id="panelToggleBtn" onclick="togglePanel()">Свернуть</button>

<script>
let map;
let points = [];
let route = [];
let selectedPlacemark = null;

// Gist для загрузки исходных точек
const LOAD_GIST_ID = 'c4b196bd97194e06592b94646e02118b';
const LOAD_FILENAME = 'all.json';

// Gist для сохранения маршрута
const SAVE_GIST_ID = '7d43c5ede26775934e66792a12fe656d';
const SAVE_FILENAME = '1.json';

let GITHUB_TOKEN = localStorage.getItem('GITHUB_TOKEN') || '';

// ------------------ TOKEN ------------------
function showTokenPrompt(message='Введите GitHub токен:'){
    document.getElementById('tokenPrompt').style.display='flex';
    document.getElementById('tokenError').textContent = message;
    document.getElementById('gistTokenInput').value = '';
}

function saveToken(){
    const t = document.getElementById('gistTokenInput').value.trim();
    if(!t){ 
        document.getElementById('tokenError').textContent = 'Токен не может быть пустым';
        return; 
    }
    GITHUB_TOKEN = t;
    localStorage.setItem('GITHUB_TOKEN', GITHUB_TOKEN);
    document.getElementById('tokenPrompt').style.display='none';
    initMap();
}

// ------------------ MAP ------------------
function round6(n){ return parseFloat(n.toFixed(6)); }

function arrowSVG(azimuth, color='blue'){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
            <g transform="rotate(${azimuth},20,20)">
                <polygon points="20,2 28,30 20,24 12,30" fill="${color}" stroke="black" stroke-width="1"/>
            </g>
        </svg>
    `);
}

function numberedArrowSVG(azimuth, number, color='blue'){
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
            <g transform="rotate(${azimuth},20,20)">
                <polygon points="20,2 28,30 20,24 12,30" fill="${color}" stroke="black" stroke-width="1"/>
            </g>
            <text x="20" y="20" font-size="16" text-anchor="middle" dominant-baseline="middle" fill="white" font-weight="bold">${number}</text>
        </svg>
    `);
}

// ------------------ ROUTE ------------------
function updateRouteList(){
    const list = document.getElementById('routeList');
    list.innerHTML = '';
    route.forEach((p, idx)=>{
        const li = document.createElement('li');
        
        const span = document.createElement('span');
        span.textContent = `${idx+1}. ${p.command}`;
        span.style.cursor = 'pointer';
        span.onclick = () => {
            map.setCenter([p.lat, p.lon], 18, {duration: 500});
        };
        li.appendChild(span);

        const delBtn = document.createElement('button');
        delBtn.textContent = '❌';
        delBtn.className = 'deleteBtn';
        delBtn.onclick = () => removeRoutePoint(idx);
        li.appendChild(delBtn);

        list.appendChild(li);
    });
}

function updatePlacemarkNumbers(){
    route.forEach((p, idx)=>{
        p.placemark.options.set('iconImageHref', numberedArrowSVG(p.azimuth, idx+1, p.color || 'blue'));
    });
}

function removeRoutePoint(index){
    const removedPoint = route.splice(index, 1)[0];
    removedPoint.placemark.options.set('iconImageHref', arrowSVG(removedPoint.azimuth, removedPoint.color || 'blue'));
    updateRouteList();
    updatePlacemarkNumbers();
}

// ------------------ COMMANDS ------------------
function showCommandBox(commands, placemark){
    selectedPlacemark = placemark;
    const list = document.getElementById('commandList');
    list.innerHTML = '';
    if(commands && commands.length){
        commands.forEach(c=>{
            const btn = document.createElement('button');
            btn.textContent = c;
            btn.onclick = () => selectCommand(c);
            list.appendChild(btn);
        });
    } else {
        list.textContent = '(нет команд)';
    }
}

function selectCommand(command){
    if(selectedPlacemark){
        const coords = selectedPlacemark.geometry.getCoordinates();
        const azMatch = selectedPlacemark.options.get('iconImageHref').match(/rotate\(([^,]+)/);
        const azimuth = azMatch ? parseFloat(azMatch[1]) : 0;

        const routePoint = {
            lat: round6(coords[0]),
            lon: round6(coords[1]),
            azimuth: azimuth,
            command: command,
            placemark: selectedPlacemark,
            color: selectedPlacemark.options.get('iconImageHrefColor') || 'blue'
        };
        route.push(routePoint);
        updateRouteList();
        updatePlacemarkNumbers();
        document.getElementById('commandList').innerHTML = '(выберите точку на карте)';
    }
}

// ------------------ SAVE ------------------
async function saveRouteToGist(){
    if(!GITHUB_TOKEN){ showTokenPrompt(); return; }
    if(route.length === 0){ alert('Маршрут пустой'); return; }

    const content = JSON.stringify(route.map(p => ({
        lat: p.lat,
        lon: p.lon,
        azimuth: p.azimuth,
        command: p.command,
        color: p.color
    })), null, 2);

    const files = {};
    files[SAVE_FILENAME] = { content };

    try {
        const response = await fetch(`https://api.github.com/gists/${SAVE_GIST_ID}`, {
            method: 'PATCH',
            headers: {'Authorization':'Bearer '+GITHUB_TOKEN,'Content-Type':'application/json'},
            body: JSON.stringify({ files })
        });
        if(!response.ok) throw new Error(`Ошибка: ${response.status}`);
        alert('Маршрут сохранён в Gist');
    } catch(e){
        alert('Ошибка сохранения: '+e.message);
    }
}

function saveRouteLocally(){
    if(route.length===0){ alert('Маршрут пустой'); return; }
    const data = JSON.stringify(route.map(p => ({
        lat: p.lat, lon: p.lon, azimuth: p.azimuth, command: p.command, color: p.color
    })), null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url;
    a.download=SAVE_FILENAME;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ------------------ LOAD ------------------
async function loadPointsFromGist(){
    if(!GITHUB_TOKEN){ showTokenPrompt(); return; }
    try{
        const resp = await fetch(`https://api.github.com/gists/${LOAD_GIST_ID}`, {
            headers:{'Authorization':'Bearer '+GITHUB_TOKEN}
        });
        if(!resp.ok){ 
            if(resp.status===401) showTokenPrompt('Неверный токен'); 
            else throw new Error(resp.status); 
            return; 
        }
        const gist = await resp.json();
        if(!gist.files[LOAD_FILENAME]) throw new Error('Файл не найден');
        const data = JSON.parse(gist.files[LOAD_FILENAME].content);
        
        points.forEach(p=>map.geoObjects.remove(p));
        points=[];

        data.forEach(item=>{
            const color = item.color || 'blue';

            const placemark = new ymaps.Placemark([round6(item.lat),round6(item.lon)], {}, {
                iconLayout:'default#image',
                iconImageHref: arrowSVG(item.azimuth||0, color),
                iconImageSize:[40,40],
                iconImageOffset:[-20,-20],
                draggable:false,
                iconImageHrefColor: color
            });
            placemark.itemCommands = item.commands||[];
            placemark.events.add('click',()=>showCommandBox(placemark.itemCommands, placemark));
            map.geoObjects.add(placemark);
            points.push(placemark);
        });
    } catch(e){ console.error(e); document.getElementById('tokenError').textContent=e.message; }
}

// ------------------ INIT MAP ------------------
function initMap(){
    ymaps.ready(()=>{
        map=new ymaps.Map("map",{center:[56.3399,43.9332],zoom:18,type:'yandex#satellite',controls:[]});
        loadPointsFromGist();
    });
}

// ------------------ TOGGLE PANEL ------------------
let panelCollapsed=false;
function togglePanel(){
    const panel=document.getElementById('sidePanel');
    panelCollapsed=!panelCollapsed;
    panelCollapsed ? panel.classList.add('collapsed') : panel.classList.remove('collapsed');
    document.getElementById('panelToggleBtn').textContent = panelCollapsed ? 'Развернуть' : 'Свернуть';
}

// ------------------ START ------------------
if(!GITHUB_TOKEN) showTokenPrompt();
else initMap();
</script>
</body>
</html>
