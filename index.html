<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Маршрут на карте с Gist</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
<style>
html, body {margin:0;height:100%;font-family:Arial;}
#map {width:100%;height:100%;}
#sidePanel {position:fixed;right:20px;top:20px;background:rgba(255,255,255,0.9);border-radius:12px;padding:12px;max-width:320px;max-height:500px;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.25);font-size:14px;z-index:1000;transition:transform 0.3s,opacity 0.3s;}
#sidePanel.collapsed {transform:translateX(110%);opacity:0;}
#sidePanel h4 {margin:8px 0;}
#routeList,#commandList,#routeSelect {margin:0;padding-left:0;}
#routeList li {display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
#routeList button.deleteBtn {background:#dc3545;border:none;color:#fff;cursor:pointer;border-radius:4px;padding:2px 6px;}
#commandList select, #routeSelect {width:100%;padding:6px;margin-bottom:6px;}
#commandList button {display:block;width:100%;padding:6px 10px;margin-bottom:6px;cursor:pointer;text-align:left;border:1px solid #ccc;border-radius:6px;background:#f0f0f0;}
#saveRouteBtn,#saveLocalBtn,#loadRouteBtn {flex:1;padding:6px 10px;border:none;border-radius:6px;color:#fff;cursor:pointer;}
#saveRouteBtn {background:#28a745;}
#saveLocalBtn {background:#17a2b8;}
#loadRouteBtn {background:#ffc107;}
#panelToggleBtn {position:fixed;right:20px;top:20px;z-index:1100;background:#007bff;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;}
#tokenPrompt {display:none;position:fixed;top:0;left:0;width:100%;height:100%;justify-content:center;align-items:center;background:rgba(0,0,0,0.4);}
#tokenPrompt>div {background:#fff;padding:24px;border-radius:16px;text-align:center;min-width:300px;}
#tokenPrompt input,#tokenPrompt button {width:100%;padding:10px;margin-top:12px;}
#tokenError {color:red;margin-top:8px;}
</style>
</head>
<body>

<div id="map"></div>

<div id="tokenPrompt">
  <div>
    <div>Введите GitHub токен для доступа к Gist:</div>
    <input id="gistTokenInput" placeholder="ghp_...">
    <button onclick="saveToken()">Сохранить</button>
    <div id="tokenError"></div>
  </div>
</div>

<div id="sidePanel">
  <h4>Маршрут</h4>
  <select id="routeSelect" onchange="loadSelectedRoute()"><option value="">-- Выберите маршрут --</option></select>
  <ul id="routeList"></ul>
  <div style="display:flex; gap:8px; margin-bottom:8px;">
    <button id="saveRouteBtn" onclick="saveRouteToGist()">Сохранить маршрут</button>
    <button id="saveLocalBtn" onclick="saveRouteLocally()">Сохранить локально</button>
    <button id="loadRouteBtn" onclick="loadSavedRoutes()">Загрузить маршруты</button>
  </div>
  <h4>Команды для выбранной точки</h4>
  <div id="commandList">(выберите точку на карте)</div>
</div>

<button id="panelToggleBtn" onclick="togglePanel()">Свернуть</button>

<script>
let map, points=[], route=[], selectedPlacemark=null, savedGistData=null;
const LOAD_GIST_ID='c4b196bd97194e06592b94646e02118b';
const LOAD_FILENAME='all.json';
const SAVE_GIST_ID='7d43c5ede26775934e66792a12fe656d';
let GITHUB_TOKEN=localStorage.getItem('GITHUB_TOKEN')||'';

const round6 = n => +n.toFixed(6);
const arrowSVG=(a,c='blue')=>`data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><g transform='rotate(${a},20,20)'><polygon points='20,2 28,30 20,24 12,30' fill='${c}' stroke='black' stroke-width='1'/></g></svg>`)}`;
const numberedArrowSVG=(a,n,c='blue')=>`data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><g transform='rotate(${a},20,20)'><polygon points='20,2 28,30 20,24 12,30' fill='${c}' stroke='black' stroke-width='1'/></g><text x='20' y='20' font-size='16' font-family='Arial' text-anchor='middle' dominant-baseline='middle' fill='white' font-weight='bold' stroke='black' stroke-width='1'>${n}</text></svg>`)}`;

function showTokenPrompt(msg='Введите GitHub токен:'){document.getElementById('tokenPrompt').style.display='flex'; document.getElementById('tokenError').textContent=msg;}
function saveToken(){const t=document.getElementById('gistTokenInput').value.trim(); if(!t){document.getElementById('tokenError').textContent='Токен не может быть пустым'; return;} GITHUB_TOKEN=t; localStorage.setItem('GITHUB_TOKEN',t); document.getElementById('tokenPrompt').style.display='none'; initMap();}

function updateRouteList(){const list=document.getElementById('routeList'); list.innerHTML=''; route.forEach((p,i)=>{
  const li=document.createElement('li');
  const span=document.createElement('span'); span.textContent=`${i+1}. ${p.command}`; span.style.cursor='pointer'; span.onclick=()=>editRoutePoint(i); li.appendChild(span);
  const delBtn=document.createElement('button'); delBtn.textContent='❌'; delBtn.className='deleteBtn'; delBtn.onclick=()=>removeRoutePoint(i); li.appendChild(delBtn);
  list.appendChild(li);
});}
function updatePlacemarkNumbers(){route.forEach((p,i)=>p.placemark.options.set('iconImageHref',numberedArrowSVG(p.azimuth,i+1,p.color||'blue')));}
function removeRoutePoint(i){const p=route.splice(i,1)[0]; if(p.placemark)p.placemark.options.set('iconImageHref',arrowSVG(p.azimuth,p.color||'blue')); updateRouteList(); updatePlacemarkNumbers();}

function editRoutePoint(i){
  const point = route[i];
  if(!point.placemark || !point.placemark.itemCommands.length){
    const newCmd = prompt('Введите команду для точки', point.command); if(newCmd){point.command=newCmd; updateRouteList();}
    return;
  }
  const sel = document.createElement('select');
  point.placemark.itemCommands.forEach(c=>{const opt=document.createElement('option'); opt.value=c; opt.text=c; if(c===point.command)opt.selected=true; sel.appendChild(opt);});
  sel.onchange=()=>{point.command=sel.value; updateRouteList(); document.getElementById('commandList').innerHTML='(выберите точку на карте)';};
  const listDiv=document.getElementById('commandList'); listDiv.innerHTML=''; listDiv.appendChild(sel);
}

function showCommandBox(cmds, pm){selectedPlacemark=pm; const list=document.getElementById('commandList'); list.innerHTML=''; if(cmds?.length) cmds.forEach(c=>{const b=document.createElement('button'); b.textContent=c; b.onclick=()=>selectCommand(c); list.appendChild(b);}); else list.textContent='(нет команд)';}
function selectCommand(command){if(!selectedPlacemark)return; const c=selectedPlacemark.geometry.getCoordinates(); route.push({lat:round6(c[0]), lon:round6(c[1]), azimuth:selectedPlacemark.azimuth||0, command, placemark:selectedPlacemark, color:selectedPlacemark.color||'blue'}); updateRouteList(); updatePlacemarkNumbers(); document.getElementById('commandList').innerHTML='(выберите точку на карте)';}

async function saveRouteToGist() {
  if (!GITHUB_TOKEN) { showTokenPrompt(); return; }
  if (!route.length) { alert('Маршрут пустой'); return; }
  const name = prompt('Введите имя маршрута:');
  if (!name?.trim()) { alert('Имя не задано'); return; }
  const filename = `${name.trim()}.json`; // ИМЯ ФАЙЛА БЕЗ "route_"
  const files = {};
  files[filename] = {
    content: JSON.stringify(
      route.map(p => ({ lat: p.lat, lon: p.lon, azimuth: p.azimuth, command: p.command, color: p.color })),
      null,
      2
    )
  };
  try {
    const r = await fetch(`https://api.github.com/gists/${SAVE_GIST_ID}`, {
      method: 'PATCH',
      headers: { Authorization: 'Bearer ' + GITHUB_TOKEN, 'Content-Type': 'application/json' },
      body: JSON.stringify({ files })
    });
    if (!r.ok) throw new Error(`Ошибка: ${r.status}`);
    alert(`Маршрут "${name}" сохранён в Gist`);
  } catch (e) { alert('Ошибка сохранения: ' + e.message); }
}

function saveRouteLocally(){if(!route.length){alert('Маршрут пустой'); return;} const blob=new Blob([JSON.stringify(route.map(p=>({lat:p.lat,lon:p.lon,azimuth:p.azimuth,command:p.command,color:p.color})),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='1.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);}

async function loadSavedRoutes(){if(!GITHUB_TOKEN){showTokenPrompt();return;} try{ const resp=await fetch(`https://api.github.com/gists/${SAVE_GIST_ID}`,{headers:{Authorization:'Bearer '+GITHUB_TOKEN}}); if(!resp.ok)throw new Error(`Ошибка: ${resp.status}`); const gist=await resp.json(); savedGistData=gist; const select=document.getElementById('routeSelect'); select.innerHTML='<option value="">-- Выберите маршрут --</option>'; Object.keys(gist.files).forEach(f=>{const opt=document.createElement('option'); opt.value=f; opt.text=f.replace('.json',''); select.appendChild(opt);}); }catch(e){alert('Ошибка загрузки: '+e.message);}}

function loadSelectedRoute(){if(!savedGistData) return; const sel=document.getElementById('routeSelect'); const fname=sel.value; if(!fname) return; const data=JSON.parse(savedGistData.files[fname].content); loadRouteFromData(data);}
function loadRouteFromData(data){route.forEach(p=>{if(p.placemark)p.placemark.options.set('iconImageHref',arrowSVG(p.azimuth,p.color||'blue'));}); route=[]; data.forEach(d=>{ const pm=points.find(p=>Math.abs(p.geometry.getCoordinates()[0]-d.lat)<1e-6 && Math.abs(p.geometry.getCoordinates()[1]-d.lon)<1e-6)||null; route.push({lat:d.lat, lon:d.lon, azimuth:d.azimuth, command:d.command, placemark:pm, color:d.color||'blue'}); }); updateRouteList(); updatePlacemarkNumbers();}

async function loadPointsFromGist(){if(!GITHUB_TOKEN){showTokenPrompt();return;} try{ const r=await fetch(`https://api.github.com/gists/${LOAD_GIST_ID}`,{headers:{Authorization:'Bearer '+GITHUB_TOKEN}}); if(!r.ok){ if(r.status===401)showTokenPrompt('Неверный токен'); else throw new Error(r.status); return;} const g=await r.json(); if(!g.files[LOAD_FILENAME]) throw new Error('Файл не найден'); points.forEach(p=>map.geoObjects.remove(p)); points=[]; const data=JSON.parse(g.files[LOAD_FILENAME].content); data.forEach(i=>{ const color=i.color||'blue'; const pm=new ymaps.Placemark([round6(i.lat),round6(i.lon)],{}, {iconLayout:'default#image', iconImageHref:arrowSVG(i.azimuth||0,color), iconImageSize:[40,40], iconImageOffset:[-20,-20], draggable:false}); pm.itemCommands=i.commands||[]; pm.azimuth=i.azimuth||0; pm.color=color; pm.events.add('click',()=>showCommandBox(pm.itemCommands,pm)); map.geoObjects.add(pm); points.push(pm); }); }catch(e){console.error(e); document.getElementById('tokenError').textContent=e.message;}}

function initMap(){ ymaps.ready(()=>{ map=new ymaps.Map('map',{center:[56.3399,43.9332],zoom:18,type:'yandex#satellite',controls:[]}); loadPointsFromGist(); }); }

let panelCollapsed=false; function togglePanel(){const p=document.getElementById('sidePanel'); panelCollapsed=!panelCollapsed; panelCollapsed?p.classList.add('collapsed'):p.classList.remove('collapsed'); document.getElementById('panelToggleBtn').textContent=panelCollapsed?'Развернуть':'Свернуть';}

if(!GITHUB_TOKEN) showTokenPrompt(); else initMap();
</script>

</body>
</html>
