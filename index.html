<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤ + GitHub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
    <style>
        body, html { margin: 0; height: 100%; font-family: 'Inter', Arial, sans-serif; overflow: hidden; }
        #map { position: absolute; inset: 0; }
        
        #panel { 
            position: absolute; top: 10px; right: 10px; width: 300px; z-index: 1000;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            max-height: 90vh; overflow-y: auto;
        }
        
        @media (max-width: 480px) {
            #panel { width: auto; left: 10px; right: 10px; }
        }

        #panel.collapsed { transform: translateY(-150%); opacity: 0; pointer-events: none; }
        
        #togglePanel {
            position: absolute; bottom: 25px; right: 20px; z-index: 1001;
            width: 50px; height: 50px; border-radius: 25px; border: none;
            background: #2f80ed; color: white; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }

        .info { background: #f4f4f7; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 12px; color: #444; line-height: 1.2; }
        .row { display: flex; gap: 8px; margin-bottom: 8px; }
        
        button { 
            flex: 1; cursor: pointer; border: none; border-radius: 8px; padding: 10px 5px; 
            background: #2f80ed; color: white; font-weight: bold; font-family: inherit;
            min-height: 44px; display: flex; align-items: center; justify-content: center;
        }
        button.danger { background: #e74c3c; }
        button.secondary { background: #6c757d; }
        button.icon-btn { font-size: 20px; background: #555; }
        button.gh-btn { background: #24292e; } /* GitHub style */
        
        textarea, .gh-input { 
            flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; 
            outline: none; font-size: 14px; font-family: inherit; width: 100%; box-sizing: border-box;
        }
        
        #palette { display: flex; gap: 6px; margin-top: 5px; overflow-x: auto; padding: 5px 2px; }
        #palette div { min-width: 28px; height: 28px; border-radius: 6px; cursor: pointer; border: 1px solid #ccc; flex-shrink: 0; box-sizing: border-box; }
        #palette div.active { border: 3px solid #000; }

        .cmd-bubble {
            position: relative; background: #ffffff; border: 2px solid #333;
            border-radius: 6px; padding: 4px 8px; font-size: 12px;
            font-weight: bold; color: #000; box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
            display: inline-block; min-width: 20px; max-width: 200px; 
            word-wrap: break-word; white-space: normal; line-height: 1.3;
        }
    </style>
</head>
<body>

<div id="map"></div>
<button id="togglePanel" onclick="document.getElementById('panel').classList.toggle('collapsed')">‚â°</button>

<div id="panel">
    <div class="row">
        <button onclick="rotate(-10)">‚ü≤ -10¬∞</button>
        <button onclick="rotate(10)">‚ü≥ +10¬∞</button>
    </div>
    <div class="row">
        <textarea id="cmdInput" placeholder="–ö–æ–º–∞–Ω–¥–∞ —Ç–æ—á–∫–∏..." oninput="autoResize(this)" onblur="saveCmd()"></textarea>
    </div>
    
    <div class="info" id="ghSettings">
        <input type="password" id="ghToken" class="gh-input" placeholder="GitHub Token" style="margin-bottom: 5px;">
        <input type="text" id="ghRepo" class="gh-input" placeholder="user/repository" style="margin-bottom: 5px;">
        <input type="text" id="ghPath" class="gh-input" placeholder="folder/route.json">
    </div>

    <div class="info" id="coordsInfo">–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...</div>
    <div class="row" style="margin-bottom: 5px;"><div id="palette"></div></div>
    
    <div class="row">
        <button class="secondary" onclick="toggleLabels()" title="üëÅÔ∏è">üëÅÔ∏è</button>
        <button class="danger" onclick="removePoint()" title="üóëÔ∏è">üóëÔ∏è</button>
        <button class="icon-btn" onclick="exportJSON()" title="üíæ">üíæ</button>
        <button class="icon-btn" onclick="importJSON()" title="üìÇ">üìÇ</button>
    </div>
    <div class="row">
        <button class="gh-btn" onclick="loadFromGitHub()">üìÇ GH</button>
        <button class="gh-btn" onclick="saveToGitHub()">üíæ GH</button>
    </div>
</div>

<script>
let map, points = [], current = null, showLabels = false, userMarker = null, currentFileSha = null;
const COLOR_PALETTE = ['Gold', 'blue', 'red', 'Lime', 'Fuchsia', 'purple', 'Silver', 'Aqua'];
const DEFAULT_CENTER = [56.3399, 43.9332];

ymaps.ready(() => {
    map = new ymaps.Map("map", { 
        center: DEFAULT_CENTER, 
        zoom: 18, 
        type: 'yandex#satellite', 
        controls: [] 
    });
    
    map.events.add('click', e => addPoint(e.get('coords')));
    
    const pal = document.getElementById('palette');
    COLOR_PALETTE.forEach(c => {
        const d = document.createElement('div');
        d.style.background = c;
        d.dataset.color = c;
        d.onclick = () => { if(current) { current.color = c; updateMarkers(); updatePaletteUI(); } };
        pal.appendChild(d);
    });

    startInitialGeolocation();
});

function startInitialGeolocation() {
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition((position) => {
            const coords = [position.coords.latitude, position.coords.longitude];
            map.setCenter(coords);
            document.getElementById('coordsInfo').innerText = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è —Ç–æ—á–∫–∏";
        }, (err) => {
            document.getElementById('coordsInfo').innerText = "GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É.";
        });

        navigator.geolocation.watchPosition((position) => {
            const coords = [position.coords.latitude, position.coords.longitude];
            if (!userMarker) {
                userMarker = new ymaps.Placemark(coords, {}, { preset: 'islands#geolocationIcon', zIndex: 2000 });
                map.geoObjects.add(userMarker);
            } else {
                userMarker.geometry.setCoordinates(coords);
            }
        }, null, { enableHighAccuracy: true });
    }
}

function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

function getIcon(azimuth, colorName, isSelected, id) {
    const fill = colorName || 'Gold';
    const stroke = isSelected ? '#2ecc71' : '#000';
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
            <g transform="rotate(${azimuth},20,20)">
                <polygon points="20,2 35,35 20,26 5,35" fill="${fill}" stroke="${stroke}" stroke-width="${isSelected?3:1.5}"/>
            </g>
            <circle cx="20" cy="20" r="9" fill="white" stroke="${fill}" stroke-width="2"/>
            <text x="20" y="24" font-size="11" font-family="Arial" font-weight="900" text-anchor="middle" fill="black">${id}</text>
        </svg>`
    );
}

function addPoint(coords) {
    document.getElementById('panel').classList.remove('collapsed');
    const p = {
        id: points.length + 1,
        lat: coords[0].toFixed(6), lon: coords[1].toFixed(6),
        azimuth: 0, color: 'Gold', command: '', pm: null
    };

    p.pm = new ymaps.Placemark(coords, { iconContent: "" }, {
        iconLayout: 'default#imageWithContent', 
        iconImageSize: [40, 40], iconImageOffset: [-20, -20], draggable: true,
        iconImageHref: getIcon(0, 'Gold', false, p.id),
        iconContentOffset: [25, -10],
        iconContentLayout: ymaps.templateLayoutFactory.createClass(
            '{% if properties.iconContent %}<div class="cmd-bubble">$[properties.iconContent]</div>{% endif %}'
        )
    });

    p.pm.events.add('click', () => selectPoint(p));
    p.pm.events.add('dragend', () => {
        const c = p.pm.geometry.getCoordinates();
        p.lat = c[0].toFixed(6); p.lon = c[1].toFixed(6);
        updateUI();
    });

    map.geoObjects.add(p.pm);
    points.push(p);
    selectPoint(p);
}

function updatePaletteUI() {
    const divs = document.querySelectorAll('#palette div');
    divs.forEach(d => {
        d.classList.toggle('active', current && d.dataset.color === current.color);
    });
}

function selectPoint(p) {
    saveCmd();
    current = p;
    const input = document.getElementById('cmdInput');
    input.value = p.command;
    autoResize(input);
    updateMarkers();
    updateUI();
    updatePaletteUI();
}

function saveCmd() { 
    if (current) { 
        current.command = document.getElementById('cmdInput').value.trim(); 
        if(showLabels) current.pm.properties.set('iconContent', current.command);
    } 
}

function toggleLabels() {
    showLabels = !showLabels;
    points.forEach(p => p.pm.properties.set('iconContent', showLabels ? p.command : ""));
}

function reindexPoints() {
    points.forEach((p, index) => p.id = index + 1);
    updateMarkers();
    updateUI();
}

function updateMarkers() {
    points.forEach(p => p.pm.options.set('iconImageHref', getIcon(p.azimuth, p.color, p === current, p.id)));
}

function updateUI() {
    const info = document.getElementById('coordsInfo');
    if (!current) { info.innerText = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É"; return; }
    info.innerHTML = `<b>ID:${current.id}</b> | ${current.lat}, ${current.lon} | <b>‚à†${current.azimuth}¬∞</b>`;
}

function rotate(deg) {
    if (!current) return;
    current.azimuth = (current.azimuth + deg + 360) % 360;
    updateMarkers(); updateUI();
}

function removePoint() {
    if (!current) return;
    map.geoObjects.remove(current.pm);
    points = points.filter(p => p !== current);
    current = null;
    reindexPoints();
    updatePaletteUI();
}

// GitHub Functions
async function loadFromGitHub() {
    const token = document.getElementById('ghToken').value;
    const repo = document.getElementById('ghRepo').value;
    const path = document.getElementById('ghPath').value;

    if (!token || !repo || !path) return alert("–í–≤–µ–¥–∏—Ç–µ Token, Repo –∏ Path");

    try {
        const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
            headers: { 'Authorization': `token ${token}`, 'Cache-Control': 'no-cache' }
        });
        if (!response.ok) throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞");
        
        const data = await response.json();
        currentFileSha = data.sha;

        const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        
        points.forEach(p => map.geoObjects.remove(p.pm));
        points = [];
        
        content.forEach(d => {
            addPoint([parseFloat(d.lat), parseFloat(d.lon)]);
            const last = points[points.length - 1];
            last.azimuth = d.azimuth || 0; 
            last.color = d.color || 'Gold'; 
            last.command = d.command || '';
        });
        reindexPoints();
        alert("–ó–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!");
    } catch (e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
    }
}

async function saveToGitHub() {
    saveCmd();
    const token = document.getElementById('ghToken').value;
    const repo = document.getElementById('ghRepo').value;
    const path = document.getElementById('ghPath').value;

    if (!token || !repo || !path) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ GitHub");

    const routeData = points.map(p => ({ 
        id: p.id, lat: p.lat, lon: p.lon, azimuth: p.azimuth, color: p.color, command: p.command 
    }));

    const body = {
        message: "Update route: " + new Date().toLocaleString(),
        content: btoa(unescape(encodeURIComponent(JSON.stringify(routeData, null, 2)))),
        sha: currentFileSha
    };

    try {
        const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const resData = await response.json();
        if (response.ok) {
            currentFileSha = resData.content.sha;
            alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ GitHub!");
        } else {
            throw new Error(resData.message);
        }
    } catch (e) {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message);
    }
}

function exportJSON() {
    saveCmd();
    const data = points.map(p => ({ id: p.id, lat: p.lat, lon: p.lon, azimuth: p.azimuth, color: p.color, command: p.command }));
    const b = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'route.json'; a.click();
}

function importJSON() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = () => {
            const data = JSON.parse(reader.result);
            points.forEach(p => map.geoObjects.remove(p.pm));
            points = [];
            data.forEach(d => {
                addPoint([parseFloat(d.lat), parseFloat(d.lon)]);
                const last = points[points.length - 1];
                last.azimuth = d.azimuth || 0; last.color = d.color || 'Gold'; last.command = d.command || '';
            });
            reindexPoints();
        };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}
</script>
</body>
</html><!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ú–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ —Å Gist</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://api-maps.yandex.ru/2.1/?apikey=YANDEX_API_KEY&lang=ru_RU"></script>
<style>
html, body {margin:0;height:100%;font-family:Arial;}
#map {width:100%;height:100%;}
#sidePanel {position:fixed;right:20px;top:20px;background:rgba(255,255,255,0.9);border-radius:12px;padding:12px;max-width:320px;max-height:500px;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.25);font-size:14px;z-index:1000;transition:transform 0.3s,opacity 0.3s;}
#sidePanel.collapsed {transform:translateX(110%);opacity:0;}
#sidePanel h4 {margin:8px 0;}
#routeList,#commandList,#routeSelect {margin:0;padding-left:0;}
#routeList li {display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
#routeList button.deleteBtn {background:#dc3545;border:none;color:#fff;cursor:pointer;border-radius:4px;padding:2px 6px;}
#commandList select, #routeSelect {width:100%;padding:6px;margin-bottom:6px;}
#commandList button {display:block;width:100%;padding:6px 10px;margin-bottom:6px;cursor:pointer;text-align:left;border:1px solid #ccc;border-radius:6px;background:#f0f0f0;}
#saveRouteBtn,#saveLocalBtn,#loadRouteBtn {flex:1;padding:6px 10px;border:none;border-radius:6px;color:#fff;cursor:pointer;}
#saveRouteBtn {background:#28a745;}
#saveLocalBtn {background:#17a2b8;}
#loadRouteBtn {background:#ffc107;}
#panelToggleBtn {position:fixed;right:20px;top:20px;z-index:1100;background:#007bff;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;}
#tokenPrompt {display:none;position:fixed;top:0;left:0;width:100%;height:100%;justify-content:center;align-items:center;background:rgba(0,0,0,0.4);}
#tokenPrompt>div {background:#fff;padding:24px;border-radius:16px;text-align:center;min-width:300px;}
#tokenPrompt input,#tokenPrompt button {width:100%;padding:10px;margin-top:12px;}
#tokenError {color:red;margin-top:8px;}
</style>
</head>
<body>

<div id="map"></div>

<div id="tokenPrompt">
  <div>
    <div>–í–≤–µ–¥–∏—Ç–µ GitHub —Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Gist:</div>
    <input id="gistTokenInput" placeholder="ghp_...">
    <button onclick="saveToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div id="tokenError"></div>
  </div>
</div>

<div id="sidePanel">
  <h4>–ú–∞—Ä—à—Ä—É—Ç</h4>
  <select id="routeSelect" onchange="loadSelectedRoute()"><option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç --</option></select>
  <ul id="routeList"></ul>
  <div style="display:flex; gap:8px; margin-bottom:8px;">
    <button id="saveRouteBtn" onclick="saveRouteToGist()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
    <button id="saveLocalBtn" onclick="saveRouteLocally()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
    <button id="loadRouteBtn" onclick="loadSavedRoutes()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã</button>
  </div>
  <h4>–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏</h4>
  <div id="commandList">(–≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ)</div>
</div>

<button id="panelToggleBtn" onclick="togglePanel()">–°–≤–µ—Ä–Ω—É—Ç—å</button>

<script>
let map, points=[], route=[], selectedPlacemark=null, savedGistData=null;
const LOAD_GIST_ID='c4b196bd97194e06592b94646e02118b';
const LOAD_FILENAME='all.json';
const SAVE_GIST_ID='7d43c5ede26775934e66792a12fe656d';
let GITHUB_TOKEN=localStorage.getItem('GITHUB_TOKEN')||'';

const round6 = n => +n.toFixed(6);
const arrowSVG=(a,c='blue')=>`data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><g transform='rotate(${a},20,20)'><polygon points='20,2 28,30 20,24 12,30' fill='${c}' stroke='black' stroke-width='1'/></g></svg>`)}`;
const numberedArrowSVG=(a,n,c='blue')=>`data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><g transform='rotate(${a},20,20)'><polygon points='20,2 28,30 20,24 12,30' fill='${c}' stroke='black' stroke-width='1'/></g><text x='20' y='20' font-size='16' font-family='Arial' text-anchor='middle' dominant-baseline='middle' fill='white' font-weight='bold' stroke='black' stroke-width='1'>${n}</text></svg>`)}`;

function showTokenPrompt(msg='–í–≤–µ–¥–∏—Ç–µ GitHub —Ç–æ–∫–µ–Ω:'){document.getElementById('tokenPrompt').style.display='flex'; document.getElementById('tokenError').textContent=msg;}
function saveToken(){const t=document.getElementById('gistTokenInput').value.trim(); if(!t){document.getElementById('tokenError').textContent='–¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'; return;} GITHUB_TOKEN=t; localStorage.setItem('GITHUB_TOKEN',t); document.getElementById('tokenPrompt').style.display='none'; initMap();}

function updateRouteList(){const list=document.getElementById('routeList'); list.innerHTML=''; route.forEach((p,i)=>{
  const li=document.createElement('li');
  const span=document.createElement('span'); span.textContent=`${i+1}. ${p.command}`; span.style.cursor='pointer'; span.onclick=()=>editRoutePoint(i); li.appendChild(span);
  const delBtn=document.createElement('button'); delBtn.textContent='‚ùå'; delBtn.className='deleteBtn'; delBtn.onclick=()=>removeRoutePoint(i); li.appendChild(delBtn);
  list.appendChild(li);
});}
function updatePlacemarkNumbers(){route.forEach((p,i)=>p.placemark.options.set('iconImageHref',numberedArrowSVG(p.azimuth,i+1,p.color||'blue')));}
function removeRoutePoint(i){const p=route.splice(i,1)[0]; if(p.placemark)p.placemark.options.set('iconImageHref',arrowSVG(p.azimuth,p.color||'blue')); updateRouteList(); updatePlacemarkNumbers();}

function editRoutePoint(i){
  const point = route[i];
  if(!point.placemark || !point.placemark.itemCommands.length){
    const newCmd = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Ç–æ—á–∫–∏', point.command); if(newCmd){point.command=newCmd; updateRouteList();}
    return;
  }
  const sel = document.createElement('select');
  point.placemark.itemCommands.forEach(c=>{const opt=document.createElement('option'); opt.value=c; opt.text=c; if(c===point.command)opt.selected=true; sel.appendChild(opt);});
  sel.onchange=()=>{point.command=sel.value; updateRouteList(); document.getElementById('commandList').innerHTML='(–≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ)';};
  const listDiv=document.getElementById('commandList'); listDiv.innerHTML=''; listDiv.appendChild(sel);
}

function showCommandBox(cmds, pm){selectedPlacemark=pm; const list=document.getElementById('commandList'); list.innerHTML=''; if(cmds?.length) cmds.forEach(c=>{const b=document.createElement('button'); b.textContent=c; b.onclick=()=>selectCommand(c); list.appendChild(b);}); else list.textContent='(–Ω–µ—Ç –∫–æ–º–∞–Ω–¥)';}
function selectCommand(command){if(!selectedPlacemark)return; const c=selectedPlacemark.geometry.getCoordinates(); route.push({lat:round6(c[0]), lon:round6(c[1]), azimuth:selectedPlacemark.azimuth||0, command, placemark:selectedPlacemark, color:selectedPlacemark.color||'blue'}); updateRouteList(); updatePlacemarkNumbers(); document.getElementById('commandList').innerHTML='(–≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ)';}

async function saveRouteToGist() {
  if (!GITHUB_TOKEN) { showTokenPrompt(); return; }
  if (!route.length) { alert('–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç–æ–π'); return; }
  const name = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–∞—Ä—à—Ä—É—Ç–∞:');
  if (!name?.trim()) { alert('–ò–º—è –Ω–µ –∑–∞–¥–∞–Ω–æ'); return; }
  const filename = `${name.trim()}.json`; // –ò–ú–Ø –§–ê–ô–õ–ê –ë–ï–ó "route_"
  const files = {};
  files[filename] = {
    content: JSON.stringify(
      route.map(p => ({ lat: p.lat, lon: p.lon, azimuth: p.azimuth, command: p.command, color: p.color })),
      null,
      2
    )
  };
  try {
    const r = await fetch(`https://api.github.com/gists/${SAVE_GIST_ID}`, {
      method: 'PATCH',
      headers: { Authorization: 'Bearer ' + GITHUB_TOKEN, 'Content-Type': 'application/json' },
      body: JSON.stringify({ files })
    });
    if (!r.ok) throw new Error(`–û—à–∏–±–∫–∞: ${r.status}`);
    alert(`–ú–∞—Ä—à—Ä—É—Ç "${name}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ Gist`);
  } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message); }
}

function saveRouteLocally(){if(!route.length){alert('–ú–∞—Ä—à—Ä—É—Ç –ø—É—Å—Ç–æ–π'); return;} const blob=new Blob([JSON.stringify(route.map(p=>({lat:p.lat,lon:p.lon,azimuth:p.azimuth,command:p.command,color:p.color})),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='1.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);}

async function loadSavedRoutes(){if(!GITHUB_TOKEN){showTokenPrompt();return;} try{ const resp=await fetch(`https://api.github.com/gists/${SAVE_GIST_ID}`,{headers:{Authorization:'Bearer '+GITHUB_TOKEN}}); if(!resp.ok)throw new Error(`–û—à–∏–±–∫–∞: ${resp.status}`); const gist=await resp.json(); savedGistData=gist; const select=document.getElementById('routeSelect'); select.innerHTML='<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç --</option>'; Object.keys(gist.files).forEach(f=>{const opt=document.createElement('option'); opt.value=f; opt.text=f.replace('.json',''); select.appendChild(opt);}); }catch(e){alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message);}}

function loadSelectedRoute(){if(!savedGistData) return; const sel=document.getElementById('routeSelect'); const fname=sel.value; if(!fname) return; const data=JSON.parse(savedGistData.files[fname].content); loadRouteFromData(data);}
function loadRouteFromData(data){route.forEach(p=>{if(p.placemark)p.placemark.options.set('iconImageHref',arrowSVG(p.azimuth,p.color||'blue'));}); route=[]; data.forEach(d=>{ const pm=points.find(p=>Math.abs(p.geometry.getCoordinates()[0]-d.lat)<1e-6 && Math.abs(p.geometry.getCoordinates()[1]-d.lon)<1e-6)||null; route.push({lat:d.lat, lon:d.lon, azimuth:d.azimuth, command:d.command, placemark:pm, color:d.color||'blue'}); }); updateRouteList(); updatePlacemarkNumbers();}

async function loadPointsFromGist(){if(!GITHUB_TOKEN){showTokenPrompt();return;} try{ const r=await fetch(`https://api.github.com/gists/${LOAD_GIST_ID}`,{headers:{Authorization:'Bearer '+GITHUB_TOKEN}}); if(!r.ok){ if(r.status===401)showTokenPrompt('–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω'); else throw new Error(r.status); return;} const g=await r.json(); if(!g.files[LOAD_FILENAME]) throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'); points.forEach(p=>map.geoObjects.remove(p)); points=[]; const data=JSON.parse(g.files[LOAD_FILENAME].content); data.forEach(i=>{ const color=i.color||'blue'; const pm=new ymaps.Placemark([round6(i.lat),round6(i.lon)],{}, {iconLayout:'default#image', iconImageHref:arrowSVG(i.azimuth||0,color), iconImageSize:[40,40], iconImageOffset:[-20,-20], draggable:false}); pm.itemCommands=i.commands||[]; pm.azimuth=i.azimuth||0; pm.color=color; pm.events.add('click',()=>showCommandBox(pm.itemCommands,pm)); map.geoObjects.add(pm); points.push(pm); }); }catch(e){console.error(e); document.getElementById('tokenError').textContent=e.message;}}

function initMap(){ ymaps.ready(()=>{ map=new ymaps.Map('map',{center:[56.3399,43.9332],zoom:18,type:'yandex#satellite',controls:[]}); loadPointsFromGist(); }); }

let panelCollapsed=false; function togglePanel(){const p=document.getElementById('sidePanel'); panelCollapsed=!panelCollapsed; panelCollapsed?p.classList.add('collapsed'):p.classList.remove('collapsed'); document.getElementById('panelToggleBtn').textContent=panelCollapsed?'–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å':'–°–≤–µ—Ä–Ω—É—Ç—å';}

if(!GITHUB_TOKEN) showTokenPrompt(); else initMap();
</script>

</body>
</html>
